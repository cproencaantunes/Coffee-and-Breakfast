name: Update Data

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch Data
        run: |
          python - <<EOF
          import requests
          import json

          data = {
              "weather": {"atual": 0, "manha": 0, "tarde": 0, "noite": 0},
              "forecast": {"max": 0, "min": 0},
              "news": [],
              "finance": []
          }

          # 1. CLIMA
          try:
              w_url = "https://api.open-meteo.com/v1/forecast?latitude=38.71&longitude=-9.13&hourly=temperature_2m&daily=temperature_2m_max,temperature_2m_min&timezone=Europe/London"
              w = requests.get(w_url, timeout=15).json()
              data["weather"] = {
                  "atual": w['hourly']['temperature_2m'][0],
                  "manha": w['hourly']['temperature_2m'][9],
                  "tarde": w['hourly']['temperature_2m'][15],
                  "noite": w['hourly']['temperature_2m'][21]
              }
              data["forecast"] = {
                  "max": w['daily']['temperature_2m_max'][1],
                  "min": w['daily']['temperature_2m_min'][1]
              }
          except Exception as e: print(f"Erro Clima: {e}")

          # 2. NOTÃCIAS
          try:
              p_res = requests.get("https://www.publico.pt/api/list/ultimas", timeout=15)
              if p_res.status_code == 200:
                  p_data = p_res.json()
                  items = p_data if isinstance(p_data, list) else p_data.get('noticias', [])
                  data["news"] = [{"title": n['titulo'], "url": n['share_url']} for n in items[:5]]
          except Exception as e: print(f"Erro Noticias: {e}")

          # 3. FINANCEIRO
          try:
              h = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0'}
              t_res = requests.get("https://www.tipranks.com/api/news/posts?limit=5", headers=h, timeout=15)
              if t_res.status_code == 200:
                  posts = t_res.json().get('posts', [])
                  data["finance"] = [{"title": p['title'], "url": f"https://www.tipranks.com/news/{p['slug']}"} for p in posts]
          except Exception as e: print(f"Erro Finance: {e}")

          with open("data.json", "w", encoding='utf-8') as f:
              json.dump(data, f, indent=4, ensure_ascii=False)
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "Update dashboard data" || exit 0
          git push
