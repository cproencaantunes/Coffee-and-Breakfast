name: Update Data

on:
  schedule:
    - cron: '0 * * * *' # Corre de hora a hora
  workflow_dispatch: # Permite correr manualmente

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch Data
        run: |
          python - <<EOF
          import requests
          import json
          from datetime import datetime

          data = {
              "weather": {},
              "forecast": {},
              "news": [],
              "finance": [],
              "last_update": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
          }

          # 1. CLIMA DETALHADO (Lisboa)
          try:
              w_url = "https://api.open-meteo.com/v1/forecast?latitude=38.71&longitude=-9.13&hourly=temperature_2m&daily=temperature_2m_max,temperature_2m_min&timezone=Europe/London"
              w_req = requests.get(w_url, timeout=15).json()
              
              # Temperaturas por período (Hoje)
              data["weather"] = {
                  "atual": w_req['hourly']['temperature_2m'][0],
                  "manha": w_req['hourly']['temperature_2m'][9],
                  "tarde": w_req['hourly']['temperature_2m'][15],
                  "noite": w_req['hourly']['temperature_2m'][21]
              }
              # Previsão para Amanhã
              data["forecast"] = {
                  "max": w_req['daily']['temperature_2m_max'][1],
                  "min": w_req['daily']['temperature_2m_min'][1]
              }
              print("Clima atualizado.")
          except Exception as e:
              print(f"Erro no Clima: {e}")

          # 2. NOTÍCIAS PÚBLICO
          try:
              p_req = requests.get("https://www.publico.pt/api/list/ultimas", timeout=15).json()
              data["news"] = [{"title": n['titulo'], "url": n['share_url']} for n in p_req[:5]]
              print("Notícias Público atualizadas.")
          except Exception as e:
              print(f"Erro no Público: {e}")

          # 3. MERCADO FINANCEIRO (TipRanks)
          try:
              headers = {'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}
              t_req = requests.get("https://www.tipranks.com/api/news/posts?limit=5", headers=headers, timeout=15).json()
              data["finance"] = [{"title": n['title'], "url": f"https://www.tipranks.com/news/{n['slug']}"} for n in t_req.get('posts', [])]
              print("TipRanks atualizado.")
          except Exception as e:
              print(f"Erro no TipRanks: {e}")

          # GRAVAR FICHEIRO
          with open("data.json", "w", encoding='utf-8') as f:
              json.dump(data, f, indent=4, ensure_ascii=False)
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "Automated data update: $(date +'%Y-%m-%d %H:%M')" || exit 0
          git push
