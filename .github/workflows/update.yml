name: Update Data

on:
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Fetch Data
        run: |
          python - <<EOF
          import requests
          import json

          data = {"weather": {}, "news": [], "finance": []}

          # 1. Clima
          try:
              w = requests.get("https://api.open-meteo.com/v1/forecast?latitude=38.71&longitude=-9.13&current_weather=true", timeout=10).json()
              data["weather"] = w.get('current_weather', {})
          except Exception as e: print(f"Erro Clima: {e}")

          # 2. Público
          try:
              p = requests.get("https://www.publico.pt/api/list/ultimas", timeout=10).json()
              data["news"] = [{"title": n['titulo'], "url": n['share_url']} for n in p[:5]]
          except Exception as e: print(f"Erro Público: {e}")

          # 3. TipRanks
          try:
              h = {'User-Agent': 'Mozilla/5.0'}
              t = requests.get("https://www.tipranks.com/api/news/posts?limit=5", headers=h, timeout=10).json()
              data["finance"] = [{"title": n['title'], "url": f"https://www.tipranks.com/news/{n['slug']}"} for n in t.get('posts', [])]
          except Exception as e: print(f"Erro TipRanks: {e}")

          with open("data.json", "w", encoding='utf-8') as f:
              json.dump(data, f, indent=4, ensure_ascii=False)
          EOF

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add data.json
          git commit -m "Update data.json" || echo "Sem alterações"
          git push || echo "Erro no push - verifica permissões"
